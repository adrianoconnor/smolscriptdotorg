---
# Feel free to add content and custom Front Matter to this file.
# To modify the layout, see https://jekyllrb.com/docs/themes/#overriding-theme-defaults

layout: default
permalink: /interactive-demo
selected_nav_item: Interactive Demo
---

<div class="md:flex mt-4 flex-col lg:flex-row">

  <div class="mx-5 basis-full lg:basis-full md:pr-10">

    <h5 class="mt-8 mb-4 text-lg font-bold bg-slate-200 dark:bg-slate-700 inline-block px-2 py-1">interactive demo</h5>

    <script src="smolscript-v0.3c.js"></script>

    <style>
      body {
        overflow-y: scroll;
      }

      .editor-inline-highlight {
        background:rgba(190, 148, 105, 0.5);
      }

      .error { 
        background: #caacac;
      }
    </style>

    <script>
      var require = {
        paths: {
          vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs'
        }
      };
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.min.js"
      integrity="sha512-6bIYsGqvLpAiEBXPdRQeFf5cueeBECtAKJjIHer3BhBZNTV3WLcLA8Tm3pDfxUwTMIS+kAZwTUvJ1IrMdX8C5w=="
      crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/editor/editor.main.nls.min.js"
      integrity="sha512-CCv+DKWw+yZhxf4Z+ExT6HC5G+3S45TeMTYcJyYbdrv4BpK2vyALJ4FoVR/KGWDIPu7w4tNCOC9MJQIkYPR5FA=="
      crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <link rel="stylesheet" type="text/css" data-name="vs/editor/editor.main"
      href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/editor/editor.main.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/editor/editor.main.js"
      integrity="sha512-BtSZPhzoyN8kq1axY6cgOFPSgLJgFwvAZ3WxeDGxEFXeFcFuK2s7Hr+zF75npVHASUY1dxudAfIVzwmgdR89Bw=="
      crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <p class="py-3 mb-3">When you run code in the editor below, it is not running directly in your web browser's Javascript
      as you might expect, it is running in a standalone VM (and that VM is running in JS). Because of that, this script
      has no access to anything like document, window or alert().</p>

    <div class="flex flex-row" style="min-width:900px;">
      <div class="w-1/3 px-3 pt-2 pb-1 text-sm">

      </div>
      <div class="w-1/3 px-3 pt-2 pb-1 text-sm bg-gray-50 dark:bg-slate-700 rounded-tl-lg">
        Compiled Bytecode
      </div>
      <div class="w-1/3 px-3 pt-2 pb-1 text-sm bg-gray-100 dark:bg-slate-800 rounded-tr-lg">
        Results (Global Variables)
      </div>
    </div>

    <div class="flex flex-row" style="min-width:900px;">
      <div class="w-1/3 bg-slate-50 dark:bg-slate-500 px-3 py-2 rounded-tl rounded-bl">
        <div style="height:200px; padding:3px;" id="smolEditor"></div>
        <div id="msgSourceChanged" class="hidden p-2 m-2 text-xs bg-red-900 text-white border border-3 border-red-400 font-sans">
          The source code has changed since it was last compiled. Stepping through the code will not
          highlight the active statement. To re-enable highlights, reset the VM and run again.
        </div>
        <div class="pt-2">
          <div class="text-right" style="position:relative;">
            <button onclick="step();" id="btnStep"
              class="xfloat-right bg-blue-500 dark:bg-slate-700 hover:bg-blue-700 dark:hover:bg-cyan-600 text-white font-bold py-1 px-4 mr-1 rounded font-sans">
              Start in Debug
            </button>

            <button onclick="run();" id="btnRun"
              class="xfloat-right bg-blue-500 dark:bg-slate-700 hover:bg-blue-700 dark:hover:bg-cyan-600 text-white font-bold py-1 px-4 mr-1 rounded font-sans">
              Run
            </button>

            <button onclick="reset();" id="btnReset"
              class="float-left bg-blue-500 dark:bg-slate-700 hover:bg-blue-700 dark:hover:bg-cyan-600 text-white font-bold py-1 px-4 mr-1 rounded font-sans hidden">
              Reset
            </button>
          </div>

          <p id="msgOutput" class="shadow-lg hidden rounded bg-slate-400 mt-3 clear-both text-sm py-1 px-2 dark:text-black"></p>
        </div>
      </div>
      <div class="w-1/3 bg-slate-100 dark:bg-slate-600 px-3 py-2" style="max-height:500px; overflow-y:scroll">
        <div id="decompiled" class="text-slate-600 dark:text-slate-300 text-xs">
          <p class="text-sm my-2">When you compile your program the bytecode-style instructions will appear here.</p>
          <p class="text-sm my-2">Instructions that have * before them are 'checkpoints' for the step through debugger. They aren't fully implemented yet so might appear weird or inconsistent if you check too closely</p>
          <p class="text-sm my-2">You'll also notice that we do some wasteful operations. We don't optimise
            the output at all right now, but we might do some simple optimisations one day.
          </p>

        </div>
      </div>
      <div class="w-1/3 bg-slate-200 dark:bg-slate-700 px-3 py-2 text-slate-700 dark:text-slate-400 text-sm rounded-br">
        <div id="results">
          <p class="text-sm my-2">When you run your program, the final value of any global variables generated by your program will be shown here.</p>
          <p class="text-sm my-2">Note that SmolScript is not 100% the same as Javascript with globals. Smol only supports var (not let), but var actually behaves like let unless its in the top-most scope.</p>
        </div>
      </div>
    </div>
    <script>
      var compiledSource = "";
      var vm;
      var decorations = [];
      var sourceChanged = false;

      function reset() {
        vm = undefined;

        document.getElementById("btnStep").innerText = "Start in Debug";    
        document.getElementById("btnReset").classList.add('hidden');

        createVM();
      }

      function createVM() {
        compiledSource = editor.getValue();
        sourceChanged = false;

        document.getElementById("decompiled").innerHTML = '';
        document.getElementById("results").innerHTML = '';
        document.getElementById("msgOutput").classList.add("hidden");
        document.getElementById("msgOutput").classList.remove("error");

        decorations = editor.deltaDecorations(decorations,[]);

        if (!document.getElementById("msgSourceChanged").classList.contains("hidden"))
        {
          document.getElementById("msgSourceChanged").classList.add("hidden");
        }

        vm = SmolScript.SmolVM.Compile(editor.getValue());
        vm.maxCycles = 100000000;

        document.getElementById("decompiled").innerHTML = `<pre>${vm.program.decompile(true)}</pre>`;
      }

      function step() {
        try {

          if (vm == undefined) {
            createVM();
          }

          document.getElementById("btnStep").innerText = "Step";         
          document.getElementById("btnReset").classList.remove('hidden');     

          document.getElementById("results").innerHTML = '';
          document.getElementById("msgOutput").innerText = '';

          if (vm.runMode == 4 || 
              (vm.code_section == 0 && vm.program.code_sections[vm.code_section].length -1 <= vm.pc)) {
            document.getElementById("msgOutput").innerText = 'Done';
            vm = undefined;
            return;
          }

          vm.step();
          
          var pending_instr = vm.program.code_sections[vm.code_section][vm.pc];

          var els = document.getElementById("decompiled").getElementsByClassName('editor-inline-highlight');
          
          [].forEach.call(els, function(el) {
            el.classList.remove('editor-inline-highlight');
          });

          var cs = document.getElementById(`cs_${vm.code_section}_${vm.pc}`);
          if (cs != undefined) {
            cs.classList.add('editor-inline-highlight');

            //cs.scrollIntoView({ behavior: 'smooth' });     

            var box = cs.parentElement.parentElement.parentElement;
            var elPos = cs.offsetTop - box.offsetTop;
            //alert(elPos);
            //alert(box.scrollTop);
            //alert(box.offsetHeight);
            box.scrollTo({ top: elPos - 50, behavior: 'smooth' }); 
          }

          const tf = vm.program.tokens[pending_instr.token_map_start_index];
          const tl = vm.program.tokens[pending_instr.token_map_end_index];

          if (tf != undefined && tl != undefined && !sourceChanged) {

              decorations = editor.deltaDecorations(decorations,[
                {
                  range: new monaco.Range
                         (
                              tf.line, 
                              tf.col + 1, 
                              tl.line, 
                              tl.col + (tl.end_pos - tl.start_pos) + 1
                         ),
                  options: { inlineClassName: "editor-inline-highlight" },
                }
              ]);
          }
          else {
            decorations = editor.deltaDecorations(decorations,[]);
          }

          var x = `<div class="shadow-lg rounded bg-slate-400 mt-2 text-black py-2 px-4"><table style="width:100%;">`;

          Object.keys(vm.globalEnv._variables).forEach((key) => {
            x += `<tr><td style="font-weight:bold;">${key}</td><td>${vm.globalEnv._variables[key].toString().replaceAll('<', '&lt;')}</td></tr>`;
          });

          x += '</table></div>';

          document.getElementById("results").innerHTML = x;
          document.getElementById("msgOutput").innerText = ``;

          if (vm.getCurrentRunMode() == 'Done') {
            vm = undefined;
            document.getElementById("msgOutput").classList.add("hidden");

          }
        }
        catch (e) {
          document.getElementById("msgOutput").innerText = e;
          document.getElementById("msgOutput").classList.remove("hidden");
          document.getElementById("msgOutput").classList.add("error");
          vm == undefined;
        }
      }

      function run() {
        try {
          
          if (vm == undefined) {
            createVM();
          }

          var els = document.getElementById("decompiled").getElementsByClassName('editor-inline-highlight');
          
          [].forEach.call(els, function(el) {
            el.classList.remove('editor-inline-highlight');
          });

          decorations = editor.deltaDecorations(decorations,[]);

          var start = window.performance.now();

          document.getElementById("results").innerHTML = '';
          document.getElementById("msgOutput").innerText = '';

          vm.run();

          var x = `<div class="shadow-lg rounded bg-slate-400 mt-2 text-black py-2 px-4"><table style="width:100%;">`;

          Object.keys(vm.globalEnv._variables).forEach((key) => {
            x += `<tr><td style="font-weight:bold;">${key}</td><td>${vm.globalEnv._variables[key].toString().replaceAll('<', '&lt;')}</td></tr>`;
          });

          x += '</table></div>';

          //x += `Stack size: ${vm.stack.length}`;

          var end = window.performance.now();
          var time = end - start;

          document.getElementById("results").innerHTML = x;
          
          if (vm.getCurrentRunMode() == 'Done') {

            vm = undefined;
            document.getElementById("btnStep").innerText = "Start in Debug";    
            document.getElementById("btnReset").classList.add('hidden');
            document.getElementById("msgSourceChanged").classList.add("hidden");

            document.getElementById("msgOutput").innerText = `Finished running program.`;
            document.getElementById("msgOutput").classList.remove("hidden");
          }
          else if (vm.getCurrentRunMode() == 'Paused') {

            // This is a bit cheeky, but it makes the 'experience' a little bit nicer

            vm.pc--;

            highlightCurrentSection();

            document.getElementById("btnStep").innerText = "Step";    
            document.getElementById("btnReset").classList.remove('hidden');
            document.getElementById("msgOutput").classList.add("hidden");
          }
        }
        catch (e) {
          document.getElementById("msgOutput").innerText = e;
          document.getElementById("msgOutput").classList.remove("hidden");
          document.getElementById("msgOutput").classList.add("error");
          vm == undefined;
        }
      }

      editor = monaco.editor.create(document.getElementById('smolEditor'), {
        value: `var y = 0;

for (var x = -2; x < 10; x++) {
  y += x;
}`,
        automaticLayout: true,
        scrollBeyondLastLine: false,
        language: 'js',
        theme: 'vs-dark',
        minimap: {
          enabled: false
        },
        //glyphMargin: false,
        folding: false,
        // Undocumented see https://github.com/Microsoft/vscode/issues/30795#issuecomment-410998882
        // lineDecorationsWidth: 0,
      });

      editor.getModel().onDidChangeContent((event) => {
        /*if (compiledSource != editor.getValue()) {
          document.getElementById("msgOutput").innerText = "Code has changed, you need to recompile!";
        }*/
        if (vm != undefined) {
          document.getElementById("msgSourceChanged").classList.remove("hidden");
          sourceChanged = true;
        }
      });

      function highlightCurrentSection() {

        var pending_instr = vm.program.code_sections[vm.code_section][vm.pc];

        var els = document.getElementById("decompiled").getElementsByClassName('editor-inline-highlight');

        [].forEach.call(els, function(el) {
          el.classList.remove('editor-inline-highlight');
        });

        var cs = document.getElementById(`cs_${vm.code_section}_${vm.pc}`);
        if (cs != undefined) {
          cs.classList.add('editor-inline-highlight');

          //cs.scrollIntoView({ behavior: 'smooth' });     

          var box = cs.parentElement.parentElement.parentElement;
          var elPos = cs.offsetTop - box.offsetTop;
          //alert(elPos);
          //alert(box.scrollTop);
          //alert(box.offsetHeight);
          box.scrollTo({ top: elPos - 50, behavior: 'smooth' }); 
        }

        const tf = vm.program.tokens[pending_instr.token_map_start_index];
        const tl = vm.program.tokens[pending_instr.token_map_end_index];

        if (tf != undefined && tl != undefined && !sourceChanged) {

            decorations = editor.deltaDecorations(decorations,[
              {
                range: new monaco.Range
                      (
                            tf.line, 
                            tf.col + 1, 
                            tl.line, 
                            tl.col + (tl.end_pos - tl.start_pos) + 1
                      ),
                options: { inlineClassName: "editor-inline-highlight" },
              }
            ]);
        }
        else {
          decorations = editor.deltaDecorations(decorations,[]);
        }

      }

    </script>

  </div>


</div>